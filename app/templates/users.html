<!DOCTYPE html>
<html>
<head>
    <title>用户管理 - 兰花数据库</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        .search-box { background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .search-box input, .search-box select { padding: 8px; margin-right: 10px; width: 200px; }
        button { padding: 6px 12px; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f8f9fa; }
        .role-select { padding: 5px; width: 120px; }
        .delete-btn { background: #dc3545; color: white; border: none; border-radius: 4px; }
        .pagination { margin-top: 20px; text-align: center; }
        .pagination button { margin: 0 5px; }
        .message { margin-top: 10px; color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>用户管理</h1>
    
    <!-- 搜索与过滤区域 -->
    <div class="search-box">
        <input type="text" id="searchUsername" placeholder="用户名">
        <select id="searchRole">
            <option value="">全部角色</option>
            <option value="admin">管理员</option>
            <option value="user">普通用户</option>
        </select>
        <button onclick="loadUsers(1)">搜索</button>
    </div>

    <!-- 用户列表表格 -->
    <table>
        <thead>
            <tr>
                <th>用户名</th>
                <th>角色</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="userList"></tbody>
    </table>

    <!-- 分页控件 -->
    <div class="pagination">
        <button onclick="changePage(-1)">上一页</button>
        <span id="currentPage">1</span> / <span id="totalPages">1</span>
        <button onclick="changePage(1)">下一页</button>
    </div>

    <!-- 消息提示 -->
    <div id="message" class="message"></div>

    <script>
        let currentPage = 1;
        let totalPages = 1;

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', () => {
            checkLoginStatus();
            loadUsers(1);
        });

        // 检查登录状态
        function checkLoginStatus() {
            const token = localStorage.getItem('token');
            if (!token) window.location.href = 'login.html';
        }

        // 加载用户数据
        async function loadUsers(page) {
            const token = localStorage.getItem('token');
            if (!token) return;
            // 构建查询参数
            const params = new URLSearchParams({
                page: page,
                limit: 10
            });
            const username = document.getElementById('searchUsername').value;
            const role = document.getElementById('searchRole').value;
            if (username) params.set('username', username);
            if (role) params.set('role', role);
            try {
                const response = await fetch(`/api/auth/users?${params}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || '加载用户失败');
                }

                const data = await response.json();
                renderUsers(data.data);
                updatePagination(data.pagination);
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        // 渲染用户列表
        function renderUsers(users) {
            const tbody = document.getElementById('userList');
            tbody.innerHTML = users.map(user => `
                <tr data-user-id="${user.user_id}">
                    <td>${user.username}</td>
                    <td>
                        <select class="role-select" 
                                onchange="updateRole(${user.user_id}, this.value)">
                            <option value="user" ${user.role === 'user' ? 'selected' : ''}>普通用户</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>管理员</option>
                        </select>
                    </td>
                    <td>
                        <button class="delete-btn" onclick="deleteUser(${user.user_id})">删除</button>
                    </td>
                </tr>
            `).join('');
        }

        // 更新分页状态
        function updatePagination(pagination) {
            currentPage = pagination.page;
            totalPages = pagination.pages;
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages;
        }

        // 翻页操作
        function changePage(offset) {
            const newPage = currentPage + offset;
            if (newPage >= 1 && newPage <= totalPages) {
                loadUsers(newPage);
            }
        }

        // 修改用户角色
        async function updateRole(userId, newRole) {
            if (!confirm(`确定将用户 #${userId} 的角色修改为 ${newRole}？`)) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/auth/role/${userId}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ role: newRole })
                });

                if (response.ok) {
                    showMessage('角色更新成功');
                    loadUsers(currentPage); // 刷新当前页
                } else {
                    const error = await response.json();
                    throw new Error(error.message);
                }
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        // 删除用户
        async function deleteUser(userId) {
            if (!confirm(`确定删除用户 #${userId}？此操作不可恢复！`)) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/auth/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showMessage('用户删除成功');
                    loadUsers(currentPage); // 刷新当前页
                } else {
                    const error = await response.json();
                    throw new Error(error.message);
                }
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        // 显示操作反馈
        function showMessage(text, type = 'success') {
            const msgDiv = document.getElementById('message');
            msgDiv.className = type;
            msgDiv.textContent = text;
            setTimeout(() => msgDiv.textContent = '', 3000);
        }
    </script>
</body>
</html>