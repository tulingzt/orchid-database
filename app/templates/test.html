<!DOCTYPE html>
<html>
<head>
    <title>兰花形态数据库系统</title>
    <style>
        /* 基础样式 */
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        .nav { background: #f0f0f0; padding: 10px; margin-bottom: 20px; }
        .nav button { margin-right: 10px; padding: 8px 15px; }
        .section { display: none; border: 1px solid #ddd; padding: 20px; }
        .active { display: block; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f8f9fa; }
        .filter-form { background: #f8f9fa; padding: 15px; margin-bottom: 20px; }
        .filter-form input, .filter-form select { margin-right: 10px; padding: 5px; }
        .modal { display: none; position: fixed; top: 20%; left: 30%; background: white; padding: 20px; border: 1px solid #ccc; z-index: 1000; }

        .species-select { max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin: 10px 0; }
        .loading { color: #666; font-style: italic; }
    </style>
</head>
<body>
    <div id="roleWarning" style="color:red; display:none;">权限不足，请重新登录</div>

    <!-- 普通用户界面 -->
    <div id="userView" style="display:none;">
        <div class="nav">
            <button onclick="showSection('speciesQuery')">种类查询</button>
            <button onclick="showSection('flowerQuery')">花朵查询</button>
            <button onclick="showSection('petalQuery')">花瓣查询</button>
            <button onclick="showSection('sepalQuery')">萼片查询</button>
        </div>

        <!-- 种类查询 -->
        <section id="speciesQuery" class="section">
            <div class="filter-form">
                <input type="text" placeholder="科名" id="family">
                <input type="text" placeholder="属名" id="genus">
                <select id="conservationStatus">
                    <option value="">全部保护级别</option>
                    <option value="无危">无危</option>
                    <option value="易危">易危</option>
                    <option value="濒危">濒危</option>
                </select>
                <input type="text" placeholder="学名关键词" id="scientificName">
                <input type="text" placeholder="中文名关键词" id="chineseName">
                <button onclick="searchSpecies()">查询</button>
            </div>
            <div id="speciesResults"></div>
        </section>

        <!-- 花朵查询 -->
        <section id="flowerQuery" class="section">
            <div class="filter-form" style="background:#e3f2fd;">
                <h4>种类筛选条件</h4>
                <input type="text" placeholder="科名" id="flowerFamily">
                <input type="text" placeholder="属名" id="flowerGenus">
                <select id="flowerConservationStatus">
                    <option value="">全部保护级别</option>
                    <option value="无危">无危</option>
                    <option value="易危">易危</option>
                    <option value="濒危">濒危</option>
                </select>
                <input type="text" placeholder="学名关键词" id="flowerScientificName">
                <input type="text" placeholder="中文名关键词" id="flowerChineseName">
                <button onclick="loadFilteredSources('flower')">加载种类</button>
                <div class="species-select" id="flowerSpeciesList"></div>
            </div>
            <div class="filter-form">
                花朵长度：<input type="number" step="0.1" id="flowerMinLength" placeholder="最小值">
                - <input type="number" step="0.1" id="flowerMaxLength" placeholder="最大值">
                花朵宽度：<input type="number" step="0.1" id="flowerMinWidth" placeholder="最小值">
                - <input type="number" step="0.1" id="flowerMaxWidth" placeholder="最大值">
                <button onclick="searchFlowers()">查询花朵</button>
            </div>
            <div id="flowerResults"></div>
        </section>

        <!-- 花瓣查询 -->
        <section id="petalQuery" class="section">
            <div class="filter-form" style="background:#e3f2fd;">
                <h4>种类筛选条件</h4>
                <input type="text" placeholder="科名" id="petalFamily">
                <input type="text" placeholder="属名" id="petalGenus">
                <select id="petalConservationStatus">
                    <option value="">全部保护级别</option>
                    <option value="无危">无危</option>
                    <option value="易危">易危</option>
                    <option value="濒危">濒危</option>
                </select>
                <input type="text" placeholder="学名关键词" id="petalScientificName">
                <input type="text" placeholder="中文名关键词" id="petalChineseName">
                <button onclick="loadFilteredSources('petal')">加载种类</button>
                <div class="species-select" id="petalSpeciesList"></div>
            </div>
            <div class="filter-form">
                花瓣长度：<input type="number" step="0.1" id="petalMinLength" placeholder="最小值">
                - <input type="number" step="0.1" id="petalMaxLength" placeholder="最大值">
                花瓣宽度：<input type="number" step="0.1" id="petalMinWidth" placeholder="最小值">
                - <input type="number" step="0.1" id="petalMaxWidth" placeholder="最大值">
                <button onclick="searchPetals()">查询花瓣</button>
            </div>
            <div id="petalResults"></div>
        </section>

        <!-- 萼片查询 -->
        <section id="sepalQuery" class="section">
            <div class="filter-form" style="background:#e3f2fd;">
                <h4>种类筛选条件</h4>
                <input type="text" placeholder="科名" id="sepalFamily">
                <input type="text" placeholder="属名" id="sepalGenus">
                <select id="sepalConservationStatus">
                    <option value="">全部保护级别</option>
                    <option value="无危">无危</option>
                    <option value="易危">易危</option>
                    <option value="濒危">濒危</option>
                </select>
                <input type="text" placeholder="学名关键词" id="sepalScientificName">
                <input type="text" placeholder="中文名关键词" id="sepalChineseName">
                <button onclick="loadFilteredSources('sepal')">加载种类</button>
                <div class="species-select" id="sepalSpeciesList"></div>
            </div>
            <div class="filter-form">
                萼片长度：<input type="number" step="0.1" id="sepalMinLength" placeholder="最小值">
                - <input type="number" step="0.1" id="sepalMaxLength" placeholder="最大值">
                萼片宽度：<input type="number" step="0.1" id="sepalMinWidth" placeholder="最小值">
                - <input type="number" step="0.1" id="sepalMaxWidth" placeholder="最大值">
                <button onclick="searchSepals()">查询萼片</button>
            </div>
            <div id="sepalResults"></div>
        </section>
    </div>

    <!-- 管理员界面 -->
    <div id="adminView" style="display:none;">
        <div class="nav">
            <button onclick="showAdminSection('userManagement')">用户管理</button>
            <button onclick="showAdminSection('speciesManagement')">种类管理</button>
            <button onclick="showAdminSection('flowerManagement')">花朵管理</button>
            <button onclick="showAdminSection('petalManagement')">花瓣管理</button>
            <button onclick="showAdminSection('sepalManagement')">萼片管理</button>
        </div>

        <!-- 种类管理 -->
        <section id="speciesManagement" class="section active">
            <button onclick="showAddModal('species')">添加新种类</button>
            <div id="speciesTable" class="loading">加载中...</div>
        </section>

        <!-- 花朵管理 -->
        <section id="flowerManagement" class="section">
            <button onclick="showAddModal('flower')">添加新花朵</button>
            <div id="flowerTable" class="loading">加载中...</div>
        </section>

        <!-- 花瓣管理 -->
        <section id="petalManagement" class="section">
            <button onclick="showAddModal('petal')">添加新花瓣</button>
            <div id="petalTable" class="loading">加载中...</div>
        </section>

        <!-- 萼片管理 -->
        <section id="sepalManagement" class="section">
            <button onclick="showAddModal('sepal')">添加新萼片</button>
            <div id="sepalTable" class="loading">加载中...</div>
        </section>

        <!-- 通用模态框 -->
        <div id="addModal" class="modal"></div>
    </div>
<script>
    // 全局状态
    let currentUserRole = '';
    let selectedSpecies = {
        flower: [],
        petal: [],
        sepal: []
    };
    
    // 初始化
    async function init() {
        const token = localStorage.getItem('token');
        if (!token) {
            alert('请先登录');
            window.location.href = '/login.html';
            return;
        }
        
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            currentUserRole = payload.role;
            
            if (currentUserRole === 'admin') {
                document.getElementById('adminView').style.display = 'block';
                showAdminSection('speciesManagement');
                await Promise.all([loadAdminData('species'), loadAdminData('flower'), 
                                 loadAdminData('petal'), loadAdminData('sepal')]);
            } else {
                document.getElementById('userView').style.display = 'block';
                showSection('speciesQuery');
            }
        } catch (error) {
            console.error('初始化失败:', error);
            document.getElementById('roleWarning').style.display = 'block';
        }
    }
    
    // 普通用户功能 -------------------------------------------------
    async function loadFilteredSources(type) {
        try {
            const params = new URLSearchParams({
                family: document.getElementById(`${type}Family`).value,
                genus: document.getElementById(`${type}Genus`).value,
                conservation_status: document.getElementById(`${type}ConservationStatus`).value,
                scientific_name: document.getElementById(`${type}ScientificName`).value,
                chinese_name: document.getElementById(`${type}ChineseName`).value
            });
            const response = await fetch(`/api/data/species?${params}`, {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
            });
            
            const result = await response.json();
            const containerId = `${type}SpeciesList`;
            const html = result.data.map(s => `
                <label>
                    <input type="checkbox" value="${s.species_id}" 
                        onchange="toggleSpecies('${type}', ${s.species_id})">
                    ${s.chinese_name} (${s.scientific_name})
                </label>
            `).join('<br>');
            
            document.getElementById(containerId).innerHTML = html;
        } catch (error) {
            console.error('加载种类失败:', error);
            alert('加载种类数据失败');
        }
    }
    
    function toggleSpecies(type, speciesId) {
        const index = selectedSpecies[type].indexOf(speciesId);
        if (index === -1) {
            selectedSpecies[type].push(speciesId);
        } else {
            selectedSpecies[type].splice(index, 1);
        }
    }

    // 普通用户查询功能
    async function searchSpecies() {
        const params = new URLSearchParams({
            family: document.getElementById('family').value,
            genus: document.getElementById('genus').value,
            conservation_status: document.getElementById('conservationStatus').value,
            scientific_name: document.getElementById('scientificName').value,
            chinese_name: document.getElementById('chineseName').value
        });

        const response = await fetch(`/api/data/species?${params}`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        
        const result = await response.json();
        renderTable(result.data, '#speciesResults', ['species_id', 'family', 'genus', 
        'scientific_name', 'chinese_name', 'distribution', 'conservation_status']);
    }
    
    async function searchFlowers() {
        const params = new URLSearchParams({
            species_ids: selectedSpecies.flower.join(','),
            min_length: document.getElementById('flowerMinLength').value,
            max_length: document.getElementById('flowerMaxLength').value,
            min_width: document.getElementById('flowerMinWidth').value,
            max_width: document.getElementById('flowerMaxWidth').value
        });
    
        try {
            const response = await fetch(`/api/data/flower?${params}`, {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
            });
            const result = await response.json();
            renderTable(result.data, '#flowerResults', ['flower_id', 'species_id', 'flower_length', 
                       'flower_width', 'flower_ratio', 'flower_area']);
        } catch (error) {
            console.error('查询失败:', error);
            alert('查询花朵数据失败');
        }
    }

    async function searchPetals() {
        const params = new URLSearchParams({
            species_ids: selectedSpecies.petal.join(','),
            min_length: document.getElementById('petalMinLength').value,
            max_length: document.getElementById('petalMaxLength').value,
            min_width: document.getElementById('petalMinWidth').value,
            max_width: document.getElementById('petalMaxWidth').value
        });
    
        try {
            const response = await fetch(`/api/data/petal?${params}`, {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
            });
            const result = await response.json();
            renderTable(result.data, '#petalResults', ['petal_id', 'flower_id', 'petal_length', 
                       'petal_width', 'petal_ratio', 'petal_area']);
        } catch (error) {
            console.error('查询失败:', error);
            alert('查询花瓣数据失败');
        }
    }
    
    async function searchSepals() {
        const params = new URLSearchParams({
            species_ids: selectedSpecies.sepal.join(','),
            min_length: document.getElementById('sepalMinLength').value,
            max_length: document.getElementById('sepalMaxLength').value,
            min_width: document.getElementById('sepalMinWidth').value,
            max_width: document.getElementById('sepalMaxWidth').value
        });
    
        try {
            const response = await fetch(`/api/data/sepal?${params}`, {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
            });
            const result = await response.json();
            renderTable(result.data, '#sepalResults', ['sepal_id', 'flower_id', 'sepal_length', 
                       'sepal_width', 'sepal_ratio', 'sepal_area']);
        } catch (error) {
            console.error('查询失败:', error);
            alert('查询萼片数据失败');
        }
    }
    
    // 管理员功能 -------------------------------------------------
    async function loadAdminData(type) {
        try {
            const response = await fetch(`/api/data/${type}?limit=1000`, {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
            });
            
            const result = await response.json();
            renderAdminTable(type, result.data);
        } catch (error) {
            console.error(`加载${type}数据失败:`, error);
            document.getElementById(`${type}Table`).innerHTML = '数据加载失败';
        }
    }
    
    function renderAdminTable(type, data) {
        const columns = {
            species: ['species_id', 'family', 'genus', 'scientific_name'],
            flower: ['flower_id', 'species_id', 'flower_length', 'flower_width'],
            petal: ['petal_id', 'flower_id', 'petal_length', 'petal_width'],
            sepal: ['sepal_id', 'flower_id', 'sepal_length', 'sepal_width']
        };
    
        const rows = data.map(item => `
            <tr>
                ${columns[type].map(col => `<td>${item[col]}</td>`).join('')}
                <td>
                    <button onclick="editItem('${type}', ${item[`${type}_id`]})">编辑</button>
                    <button onclick="deleteItem('${type}', ${item[`${type}_id`]})">删除</button>
                </td>
            </tr>
        `).join('');
    
        document.getElementById(`${type}Table`).innerHTML = `
            <table>
                <tr>${columns[type].map(col => `<th>${col}</th>`).join('')}<th>操作</th></tr>
                ${rows}
            </table>`;
    }
    
    // 显示/隐藏控制
    function showSection(sectionId) {
        document.querySelectorAll('#userView .section').forEach(s => s.classList.remove('active'));
        document.getElementById(sectionId).classList.add('active');
    }
    
    function showAdminSection(sectionId) {
        document.querySelectorAll('#adminView .section').forEach(s => s.classList.remove('active'));
        document.getElementById(sectionId).classList.add('active');
    }
    
    // 通用工具
    function renderTable(data, container, columns) {
        const rows = data.map(item => `
            <tr>${columns.map(col => `<td>${item[col]}</td>`).join('')}</tr>
        `).join('');
        
        document.querySelector(container).innerHTML = `
            <table>
                <tr>${columns.map(col => `<th>${col}</th>`).join('')}</tr>
                ${rows}
            </table>`;
    }
    // 在script部分添加以下代码
    // 添加数据功能
    async function showAddModal(type) {
        const formConfig = {
            species: [
                {id: 'family', label: '科名', required: true},
                {id: 'genus', label: '属名', required: true},
                {id: 'scientificName', label: '学名', required: true},
                {id: 'chineseName', label: '中文名', required: true},
                {id: 'conservationStatus', label: '保护级别', type: 'select', options: ['无危','易危','濒危']}
            ],
            flower: [
                {id: 'speciesId', label: '物种ID', type: 'number', required: true},
                {id: 'flowerLength', label: '花朵长度(cm)', type: 'number', step: 0.1, required: true},
                {id: 'flowerWidth', label: '花朵宽度(cm)', type: 'number', step: 0.1, required: true}
            ],
            // 其他类型类似配置...
        };

        const formHTML = formConfig[type].map(field => {
            if(field.type === 'select') {
                return `
                <div class="form-group">
                    <label>${field.label}:</label>
                    <select id="add${field.id}" class="form-control" ${field.required ? 'required' : ''}>
                        ${field.options.map(o => `<option value="${o}">${o}</option>`).join('')}
                    </select>
                </div>`;
            }
            return `
            <div class="form-group">
                <label>${field.label}:</label>
                <input type="${field.type || 'text'}" 
                    id="add${field.id}" 
                    ${field.step ? `step="${field.step}"` : ''}
                    ${field.required ? 'required' : ''}
                    class="form-control">
            </div>`;
        }).join('');

        const modalContent = `
        <div class="modal-content">
            <h3>添加新${getChineseName(type)}</h3>
            ${formHTML}
            <button onclick="submitAddForm('${type}')">提交</button>
            <button onclick="closeModal()">取消</button>
        </div>`;

        document.getElementById('addModal').innerHTML = modalContent;
        document.getElementById('addModal').style.display = 'block';
    }

    async function submitAddForm(type) {
        const fieldMappings = {
            species: {
                family: 'family',
                genus: 'genus',
                scientificName: 'scientific_name',
                chineseName: 'chinese_name',
                conservationStatus: 'conservation_status'
            },
            flower: {
                speciesId: 'species_id',
                flowerLength: 'flower_length',
                flowerWidth: 'flower_width'
            }
        };

        const requiredFields = {
            species: ['family', 'genus', 'scientificName', 'chineseName'],
            flower: ['speciesId', 'flowerLength', 'flowerWidth']
        };

        try {
            // 验证必填字段
            const missingFields = requiredFields[type].filter(field => {
                const element = document.getElementById(`add${field}`);
                return !element.value.trim();
            });

            if (missingFields.length > 0) {
                alert(`以下字段必须填写: ${missingFields.join(', ')}`);
                return;
            }

            // 构建payload
            const payload = {};
            for (const [frontendField, backendField] of Object.entries(fieldMappings[type])) {
                const element = document.getElementById(`add${frontendField}`);
                let value = element.value;

                // 数值类型转换
                if (['flower_length', 'flower_width'].includes(backendField)) {
                    value = parseFloat(value);
                    if (isNaN(value)) {
                        alert(`${element.labels[0].textContent} 必须为有效数字`);
                        return;
                    }
                }

                payload[backendField] = value;
            }

            const response = await fetch(`/api/data/${type}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify(payload)
            });

            const responseData = await response.json();
            
            if (response.ok) {
                alert('添加成功');
                closeModal();
                loadAdminData(type);
            } else {
                alert(`添加失败: ${responseData.message || '未知错误'}`);
            }
        } catch (error) {
            console.error('添加失败:', error);
            alert('网络请求失败，请检查控制台');
        }
    }

    // 编辑功能
    async function editItem(type, id) {
        // 获取现有数据
        const response = await fetch(`/api/data/${type}/${id}`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        const data = await response.json();
        
        // 显示编辑模态框（类似添加表单）
        // 填充现有数据并执行更新操作
    }

    // 删除功能
    async function deleteItem(type, id) {
        if(!confirm('确定要删除该记录吗？')) return;
        
        try {
            const response = await fetch(`/api/data/${type}/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
            });
            
            if(response.ok) {
                alert('删除成功');
                loadAdminData(type);
            }
        } catch (error) {
            console.error('删除失败:', error);
            alert('删除操作失败');
        }
    }

    // 通用工具函数
    function getChineseName(type) {
        const names = {
            species: '种类',
            flower: '花朵',
            petal: '花瓣',
            sepal: '萼片'
        };
        return names[type] || type;
    }

    function closeModal() {
        document.getElementById('addModal').style.display = 'none';
    }
    
    // 初始化执行
    init();
    </script>
</body>
</html>