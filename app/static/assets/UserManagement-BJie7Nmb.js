import{x as F,l as y,d as I,r as c,q as C,a as O,c as x,b as o,w as i,e as d,m as U,o as _,i as k,j as E,k as b,g as G,t as H,E as L,y as J}from"./index-CrBMAzv8.js";import{D as K}from"./DataTable-4gAKRNCn.js";const Q=F("user",{state:()=>({userList:[],userPagination:{total:0,page:1,pages:0,per_page:0},loading:!1}),actions:{async createUser(n){try{await y.register({username:n.username,password:n.password,admin_secret:n.admin_secret}),await this.fetchUsers()}catch(a){throw new Error(a.message)}},async fetchUsers(n){this.loading=!0;try{const a=await y.getUsers(n);this.userList=a.data,this.userPagination=a.pagination}finally{this.loading=!1}},async updateUserRole(n,a){await y.updateUserRole(n,a);const u=this.userList.find(f=>f.user_id===n);u&&(u.role=a)},async deleteUser(n){await y.deleteUser(n),this.userList=this.userList.filter(a=>a.user_id!==n)}}}),W={class:"management-container"},X={key:0,class:"form-tip error"},ee=I({__name:"UserManagement",setup(n){const a=Q(),u=c(!1),f=c(),v=c(null),V=c("create"),g=c(""),h=c(!1),m=C(()=>V.value==="create"),S=C(()=>m.value?"新增用户":"编辑用户"),B=[{prop:"user_id",label:"ID",width:80},{prop:"username",label:"用户名"},{prop:"role",label:"角色",formatter:t=>t=="admin"?"管理员":"普通用户"},{prop:"created_time",label:"注册时间",width:180}],s=O({username:"",password:"",role:"user",admin_secret:""}),R=C(()=>({username:[{required:!0,message:"请输入用户名",trigger:"blur"}],password:[{required:m.value,min:6,message:"密码长度至少6位",trigger:"blur"}],admin_secret:{validator:(t,e,r)=>{s.role==="admin"&&m.value?e?r():r(new Error("创建管理员需要提供密钥")):r()},trigger:"blur"}})),P=(t,e)=>{var r;V.value=t,(r=f.value)==null||r.resetFields(),g.value="",t==="edit"&&e?(v.value=e.user_id,s.role=e.role):(v.value=null,Object.assign(s,{username:"",password:"",role:"user",admin_secret:""})),u.value=!0},z=async()=>{h.value=!0,g.value="";try{await f.value.validate(),V.value==="create"?await a.createUser({username:s.username,password:s.password,admin_secret:s.role==="admin"?s.admin_secret:void 0}):v.value&&await a.updateUserRole(v.value,s.role),u.value=!1,a.fetchUsers()}catch(t){N(t)}finally{h.value=!1}},N=t=>{var r,p;const e=((p=(r=t.response)==null?void 0:r.data)==null?void 0:p.message)||"操作失败";e.includes("admin_secret")?(g.value="管理员密钥验证失败，请检查输入",s.admin_secret=""):e.includes("username")?L.error("用户名已存在"):L.error(e)},T=async t=>{try{await J.confirm(`确定要删除用户 ${t.username} 吗？此操作不可逆！`,"警告",{type:"warning"}),await a.deleteUser(t.user_id),a.fetchUsers()}catch(e){console.error("删除取消或失败:",e)}},q=t=>{a.userPagination.page=t,a.fetchUsers()},M=t=>{a.userPagination.per_page=t,a.fetchUsers()};return a.fetchUsers(),(t,e)=>{const r=d("el-button"),p=d("el-input"),w=d("el-form-item"),D=d("el-option"),$=d("el-select"),j=d("el-form"),A=d("el-dialog");return _(),x("div",W,[o(r,{type:"primary",onClick:e[0]||(e[0]=l=>P("create"))},{default:i(()=>e[8]||(e[8]=[k("新增用户")])),_:1}),o(K,{columns:B,data:U(a).userList,total:U(a).userPagination.total,"page-size":U(a).userPagination.per_page,loading:U(a).loading,"show-actions":!0,onPageChange:q,onSizeChange:M,onEdit:e[1]||(e[1]=l=>P("edit",l)),onDelete:T},null,8,["data","total","page-size","loading"]),o(A,{modelValue:u.value,"onUpdate:modelValue":e[7]||(e[7]=l=>u.value=l),title:S.value},{footer:i(()=>[o(r,{onClick:e[6]||(e[6]=l=>u.value=!1)},{default:i(()=>e[10]||(e[10]=[k("取消")])),_:1}),o(r,{type:"primary",onClick:z,loading:h.value},{default:i(()=>e[11]||(e[11]=[k(" 确认 ")])),_:1},8,["loading"])]),default:i(()=>[o(j,{model:s,rules:R.value,ref_key:"formRef",ref:f,"label-position":"top"},{default:i(()=>[m.value?(_(),E(w,{key:0,label:"用户名",prop:"username"},{default:i(()=>[o(p,{modelValue:s.username,"onUpdate:modelValue":e[2]||(e[2]=l=>s.username=l)},null,8,["modelValue"]),e[9]||(e[9]=G("div",{class:"form-tip"},"用户名需唯一且不可重复",-1))]),_:1})):b("",!0),m.value?(_(),E(w,{key:1,label:"密码",prop:"password"},{default:i(()=>[o(p,{modelValue:s.password,"onUpdate:modelValue":e[3]||(e[3]=l=>s.password=l),type:"password","show-password":"",placeholder:"至少6位字符"},null,8,["modelValue"])]),_:1})):b("",!0),o(w,{label:"用户角色",prop:"role"},{default:i(()=>[o($,{modelValue:s.role,"onUpdate:modelValue":e[4]||(e[4]=l=>s.role=l)},{default:i(()=>[o(D,{label:"普通用户",value:"user"}),o(D,{label:"管理员",value:"admin"})]),_:1},8,["modelValue"])]),_:1}),s.role==="admin"&&m.value?(_(),E(w,{key:2,label:"管理员密钥",prop:"admin_secret"},{default:i(()=>[o(p,{modelValue:s.admin_secret,"onUpdate:modelValue":e[5]||(e[5]=l=>s.admin_secret=l),type:"password","show-password":"",placeholder:"请输入管理员注册密钥"},null,8,["modelValue"]),g.value?(_(),x("div",X,H(g.value),1)):b("",!0)]),_:1})):b("",!0)]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"])])}}});export{ee as default};
